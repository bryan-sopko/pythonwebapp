name: SonarQube Code Scanning

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
  schedule:
    - cron: '0 0 * * 0'  # Weekly scan on Sunday at midnight

jobs:
  sonarqube-analysis:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
      
      - name: Debug - Check secrets
        run: |
          echo "SONAR_HOST_URL is set: ${{ secrets.SONAR_HOST_URL != '' }}"
          echo "SONAR_TOKEN is set: ${{ secrets.SONAR_TOKEN != '' }}"
      
      - name: Download and setup SonarScanner
        run: |
          wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-7.3.0.5189-linux-x64.zip
          unzip -q sonar-scanner-cli-7.3.0.5189-linux-x64.zip
          echo "$GITHUB_WORKSPACE/sonar-scanner-7.3.0.5189-linux-x64/bin" >> $GITHUB_PATH
      
      - name: Run SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=python-demo \
            -Dsonar.sources=app \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
      
      - name: Wait for analysis to complete
        run: sleep 30
      
      - name: Download and Convert to SARIF
        run: |
          echo "Downloading issues from SonarQube..."
          
          # Download ALL issues from SonarQube (not filtering by type since CODE_SMELL is important too)
          curl -u "${{ secrets.SONAR_TOKEN }}:" \
            "${{ secrets.SONAR_HOST_URL }}/api/issues/search?componentKeys=python-demo&ps=500" \
            -o sonarqube-issues.json
          
          echo "SonarQube response:"
          cat sonarqube-issues.json | python3 -m json.tool | head -30
          
          # Create SARIF with actual issues
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          
          # Load SonarQube issues
          with open('sonarqube-issues.json', 'r') as f:
              data = json.load(f)
          
          print(f"Found {len(data.get('issues', []))} issues from SonarQube")
          
          # Convert to SARIF
          sarif = {
              "version": "2.1.0",
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "SonarQube",
                          "informationUri": "https://www.sonarqube.org/",
                          "version": "1.0",
                          "rules": []
                      }
                  },
                  "results": []
              }]
          }
          
          # Convert each issue
          for issue in data.get('issues', []):
              component = issue.get('component', '').replace('python-demo:', '')
              message = issue.get('message', 'No description')
              rule = issue.get('rule', 'unknown')
              severity = issue.get('severity', 'MAJOR')
              line = issue.get('line', 1)
              issue_type = issue.get('type', 'BUG')
              
              print(f"Processing issue: {rule} in {component}:{line}")
              
              # Map SonarQube severity to SARIF level
              level_map = {
                  'BLOCKER': 'error',
                  'CRITICAL': 'error',
                  'MAJOR': 'warning',
                  'MINOR': 'note',
                  'INFO': 'note'
              }
              
              result = {
                  "ruleId": rule,
                  "level": level_map.get(severity, 'warning'),
                  "message": {
                      "text": f"[{issue_type}] {message}"
                  },
                  "locations": [{
                      "physicalLocation": {
                          "artifactLocation": {
                              "uri": component
                          },
                          "region": {
                              "startLine": line
                          }
                      }
                  }]
              }
              
              sarif['runs'][0]['results'].append(result)
          
          # Write SARIF file
          with open('sonarqube.sarif', 'w') as f:
              json.dump(sarif, f, indent=2)
          
          print(f"✅ Converted {len(sarif['runs'][0]['results'])} issues to SARIF")
          print("\nSARIF preview:")
          print(json.dumps(sarif, indent=2)[:500])
          
          # Exit with error if no issues found
          if len(sarif['runs'][0]['results']) == 0:
              print("⚠️ WARNING: No issues found in SonarQube!")
              print("Check if the analysis completed successfully")
          PYTHON_SCRIPT
          
          echo "SARIF file contents:"
          cat sonarqube.sarif
      
      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sonarqube.sarif
          category: sonarqube
        if: always()
